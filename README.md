# DifferentiableMoM.jl

Julia implementation of a differentiable EFIE-MoM workflow for inverse design of reactive impedance metasurfaces.

## Quick Start

From this folder:

```bash
julia --project=. test/runtests.jl
julia --project=. examples/ex_beam_steer.jl
julia --project=. examples/ex_auto_preconditioning.jl
julia --project=. examples/ex_pec_sphere_rcs.jl
julia --project=. examples/ex_pec_sphere_mie_benchmark.jl
julia --project=. plot.jl
julia --project=. validation/paper/generate_consistency_report.jl
```

For an external sphere mesh:
```bash
julia --project=. examples/ex_pec_sphere_rcs.jl path/to/sphere.obj
julia --project=. examples/ex_pec_sphere_mie_benchmark.jl path/to/sphere.obj 3.0
```

## Repository Layout

- `src/`: core solver and optimization implementation
- `examples/`: reproducible study scripts
- `test/`: verification and consistency tests
- `data/`: generated numerical outputs used by manuscript tables/claims
- `figs/`: **generated figures** (ignored by git; regenerate with `julia --project=. plot.jl`)
- `validation/bempp/`: independent Bempp-cl cross-validation scripts

## Data vs Figures Policy

- `data/` is generated by tests/examples/validation scripts and is not tracked by default.
- `figs/` is generated output and is intentionally not tracked.
- For paper snapshots, archive the generated `data/` directory (or selected files) with the tagged submission commit.

## Bempp Cross-Validation

See `validation/bempp/README.md` for setup and commands.
For acceptance-focused impedance external checks, use
`validation/bempp/run_impedance_validation_matrix.py`.
For convention-reconciliation sweeps, use
`validation/bempp/sweep_impedance_conventions.py`.

## Optional Preconditioning Modes

Optimization APIs (`optimize_lbfgs`, `optimize_directivity`) support:

- `preconditioning=:off` (default)
- `preconditioning=:on` (always apply mass-based left preconditioner)
- `preconditioning=:auto` (enable only for larger/iterative settings)

You can still provide an explicit matrix via `preconditioner_M=...`, which
overrides the mode selection.

See `examples/ex_auto_preconditioning.jl` for a runnable example with
recommended `:auto` settings for large / iterative runs.

## Paper Consistency Snapshot

Generate a manuscript-facing metrics snapshot from tracked CSV outputs:

```bash
julia --project=. validation/paper/generate_consistency_report.jl
```

This writes:
- `data/paper_metrics_snapshot.csv`
- `data/paper_consistency_report.md`

## Sphere Mie CI Gate

`test/runtests.jl` includes a dedicated PEC-sphere MoM-vs-Mie gate
(Test 13) that enforces dB-threshold checks on:
- `MAE`
- `RMSE`
- max absolute dB error on the cut
- backscatter dB difference

It also writes `data/sphere_mie_gate_metrics.csv`.
